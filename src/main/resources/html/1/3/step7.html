<div class="container">
  <h2>Вибірка з умовами, групові функції, WHERE і HAVING</h2>

  <p><strong>WHERE</strong> і <strong>HAVING</strong> можна використовувати в одному запиті. При цьому слід враховувати порядок виконання SQL-запиту на сервері:</p>

  <ol>
    <li>FROM</li>
    <li>WHERE</li>
    <li>GROUP BY</li>
    <li>HAVING</li>
    <li>SELECT</li>
    <li>ORDER BY</li>
  </ol>

  <p>Спочатку визначається таблиця (FROM), далі з неї відбираються записи відповідно до умови WHERE. Потім вибрані записи групуються (GROUP BY), з них обираються ті, що задовольняють умову HAVING. Після цього формується вибірка SELECT, і вже в кінці результати сортуються (ORDER BY).</p>

  <div id="toggle1" style="cursor:pointer;">
    <div>
      <span class="arrow-text"><strong>Примітка</strong></span>
    </div>
  </div>
  <div id="hiddenText1" style="display:none;">
    <p>Порядок виконання запиту — не те саме, що порядок запису ключових слів. Наприклад, у WHERE не можна використовувати імена виразів із SELECT, бо SELECT виконується пізніше.</p>
  </div>

  <p><strong>Приклад</strong></p>
  <p>Вивести максимальну та мінімальну ціну книг кожного автора, крім <strong>Есеніна С.А.</strong>, лише для тих, у кого кількість примірників книг більше 10:</p>

  <pre class="sqlCodeBlock">SELECT author,
    MIN(price) AS Мінімальна_ціна,
    MAX(price) AS Максимальна_ціна
FROM book
WHERE author <> 'Есенин С.А.'
GROUP BY author
HAVING SUM(amount) > 10;</pre>

  <p class="skewed">Результат:</p>

  <pre class="sqlResultTable">+------------------+------------------+-------------------+
| author           | Мінімальна_ціна  | Максимальна_ціна  |
+------------------+------------------+-------------------+
| Достоевский Ф.М. | 460.00           | 799.01            |
+------------------+------------------+-------------------+</pre>

  <p>Другий спосіб — умову <code>author &lt;&gt; 'Есенин С.А.'</code> перенести в HAVING:</p>

  <pre class="sqlCodeBlock">SELECT author,
    MIN(price) AS Мінімальна_ціна,
    MAX(price) AS Максимальна_ціна
FROM book
GROUP BY author
HAVING SUM(amount) > 10 AND author <> 'Есенин С.А.';</pre>

  <div id="toggle2" style="cursor:pointer;">
    <div>
      <span class="arrow-text"><strong>Пояснення</strong></span>
    </div>
  </div>
  <div id="hiddenText2" style="display:none;">
    <p>У другому випадку база рахує мінімальну й максимальну ціну <em>усіх</em> авторів, а потім прибирає Есеніна. Це витрачає більше ресурсів, тому перший варіант — кращий.</p>
  </div>

  <h2>Завдання</h2>
  <p>Порахувати сумарну вартість усіх примірників книг кожного автора, крім книг <code>Ідіот</code> і <code>Біла гвардія</code>. У результаті залишити лише тих авторів, у кого загальна вартість книг (без цих двох книг) перевищує 5000. Назвати обчислюваний стовпець <code>Вартість</code>. Відсортувати результат за спаданням вартості.</p>

  <div id="toggle3" style="cursor:pointer;">
    <div>
      <span class="arrow-text"><strong>Результат</strong></span>
    </div>
  </div>
  <div id="hiddenText3" style="display:none;">
    <pre class="sqlResultTable">+------------------+-----------+
| author           | Вартість  |
+------------------+-----------+
| Есенин С.А.      | 9750.00   |
| Достоевский Ф.М. | 7202.03   |
+------------------+-----------+</pre>
  </div>
  <p></p>

  <div id="toggle4" style="cursor:pointer;">
    <div>
      <span class="arrow-text"><strong>Структура та наповнення таблиці <code>book</code></strong></span>
    </div>
  </div>
  <div id="hiddenText4" style="display:none;">
    <pre class="sqlResultTable">+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+</pre>
  </div>
</div>
