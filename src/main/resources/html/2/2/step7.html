<div class="container">

    <h2>Вкладені запити в операторах з'єднання</h2>

    <p>
        Вкладені запити можуть використовуватись в операторах з'єднання <code>JOIN</code>. У такому випадку їм необхідно
        присвоювати ім’я, яке записується одразу після закриваючої дужки вкладеного запиту.
    </p>

    <pre class="sqlResultTable">SELECT
 ...
FROM
    таблиця ... JOIN  
       (
        SELECT ...
       ) ім'я_вкладеного_запиту
    ON умова
...</pre>

    <p>
        Вкладений запит може стояти як справа, так і зліва від оператора <code>JOIN</code>. Допускається використання
        двох
        запитів в операторах з'єднання.
    </p>

    <h3>Приклад</h3>
    <p>Вивести авторів, які пишуть книги в найпопулярніших жанрах. Вказати ці жанри.</p>


    <p>
        Найпопулярнішим вважати жанр, загальна кількість примірників книг якого на складі є максимальною.
        Таких жанрів може бути кілька, якщо вони мають однакове максимальне значення кількості примірників.
        Лише для цього кроку було змінено запис у таблиці <code>book</code>.
    </p>

    <p>Оновлений запис у таблиці <code>book</code>:</p>
    <table class="tableSql">
        <thead>
            <tr>
                <th>book_id</th>
                <th>title</th>
                <th>author_id</th>
                <th>genre_id</th>
                <th>price</th>
                <th>amount</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>8</td>
                <td>Лірика</td>
                <td>4</td>
                <td>2</td>
                <td>518.99</td>
                <td>10</td>
            </tr>
        </tbody>
    </table>

    <p>А також додано нові записи:</p>
    <table class="tableSql">
        <thead>
            <tr>
                <th>book_id</th>
                <th>title</th>
                <th>author_id</th>
                <th>genre_id</th>
                <th>price</th>
                <th>amount</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>9</td>
                <td>Герой нашого часу</td>
                <td>5</td>
                <td>3</td>
                <td>570.59</td>
                <td>2</td>
            </tr>
            <tr>
                <td>10</td>
                <td>Доктор Живаго</td>
                <td>4</td>
                <td>3</td>
                <td>740.50</td>
                <td>5</td>
            </tr>
        </tbody>
    </table>

    <p>
        Розглянемо реалізацію цього запиту по кроках.
    </p>



    <p><strong>Крок 1.</strong> Знайдемо загальну кількість книг по кожному жанру, відсортуємо його за спаданням та
        обмежимо виведення одним рядком. Рекомендується, якщо запит буде використовуватися як вкладене (особливо в
        операціях з'єднання), що обчислюється полям запиту давати власне ім'я.</p>
    <p class="skewed">Запит:</p>
    <pre class="sqlResultTable">SELECT genre_id, SUM(amount) AS sum_amount
FROM book
GROUP BY genre_id
ORDER BY sum_amount DESC
LIMIT 1;</pre>

    <p class="skewed">Результат:</p>
    <pre class="sqlResultTable">+-----------+------------+
| genre_id  | sum_amount |
+-----------+------------+
| 1         | 31         |
+-----------+------------+</pre>

    <p>
        Здається, що, використовуючи цей запит, вже можна отримати <code>id</code> найпопулярнішого жанру. Але це не
        так,
        оскільки кілька жанрів можуть мати однакову популярність. Тому нам потрібен запит, який вибере
        <strong>УСІ</strong> жанри,
        загальна кількість книг яких дорівнює <code>sum_amount</code>.
    </p>


    <p><strong>Крок 2.</strong>
        Використовуючи запит з попереднього кроку, знайдемо <code>id</code> найпопулярніших жанрів.</p>
    <p class="skewed">Запит:</p>
    <pre class="sqlResultTable">SELECT query_in_1.genre_id
FROM 
    (SELECT genre_id, SUM(amount) AS sum_amount
     FROM book
     GROUP BY genre_id) query_in_1
INNER JOIN
    (SELECT genre_id, SUM(amount) AS sum_amount
     FROM book
     GROUP BY genre_id
     ORDER BY sum_amount DESC
     LIMIT 1) query_in_2
ON query_in_1.sum_amount = query_in_2.sum_amount;</pre>

    <p class="skewed">Результат:</p>
    <pre class="sqlResultTable">+-----------+
| genre_id  |
+-----------+
| 1         |
| 2         |
+-----------+</pre>

    <p><strong>Крок 3.</strong>
        Використовуючи запит з кроку 2, виведемо прізвища авторів, які пишуть у найпопулярніших жанрах, та назви цих
        жанрів.
        У цьому запиті обов’язково потрібно виконати групування за прізвищами авторів та <code>id</code> жанрів,
        оскільки без цього прізвища авторів будуть повторюватися, бо в таблиці <code>book</code> є різні книги, написані
        автором в одному жанрі.
    </p>
    <p class="skewed">Запит:</p>
    <pre class="sqlResultTable">SELECT name_author, name_genre
FROM author
INNER JOIN book ON author.author_id = book.author_id
INNER JOIN genre ON book.genre_id = genre.genre_id
GROUP BY name_author, name_genre, genre.genre_id
HAVING genre.genre_id IN (
    SELECT query_in_1.genre_id
    FROM 
        (SELECT genre_id, SUM(amount) AS sum_amount
         FROM book
         GROUP BY genre_id) query_in_1
    INNER JOIN
        (SELECT genre_id, SUM(amount) AS sum_amount
         FROM book
         GROUP BY genre_id
         ORDER BY sum_amount DESC
         LIMIT 1) query_in_2
    ON query_in_1.sum_amount = query_in_2.sum_amount
);</pre>

    <p class="skewed">Результат:</p>
    <pre class="sqlResultTable">+------------------+------------+
| name_author      | name_genre |
+------------------+------------+
| Достоєвський Ф.М.| Роман      |
| Булгаков М.А.    | Роман      |
| Пастернак Б.Л.   | Поезія     |
| Єсенін С.А.      | Поезія     |
+------------------+------------+</pre>


    <p><strong>Увага!</strong></p>

    <p>
        Зверніть увагу, що в групування включено стовпець <code>genre_id</code>, який використовується в умові
        <code>HAVING</code>.
        Це пов’язано з тим, що в <code>HAVING</code> можна використовувати лише ті стовпці, які перелічені в
        <code>GROUP BY</code>,
        або стовпці, обчислені за допомогою агрегатних функцій.
        Додавання стовпця <code>genre_id</code> не впливає на групування, оскільки між назвою жанру та його
        <code>id</code>
        існує взаємно однозначна відповідність.
    </p>

    <p>
        Назву стовпця <code>genre_id</code> вказують разом з іменем таблиці (<code>genre.genre_id</code>),
        оскільки цей стовпець входить до структури двох таблиць — <code>book</code> і <code>genre</code>.
        У цьому запиті також можна було б вказати <code>book.genre_id</code>, оскільки ці таблиці пов’язані внутрішнім
        з’єднанням
        (<code>INNER JOIN</code>) і мають однакові значення у відповідних полях.
    </p>

    <p class="skewed">Результат:</p>
    <pre class="sqlResultTable">+------------------+------------+
| name_author      | name_genre |
+------------------+------------+
| Достоєвський Ф.М.| Роман      |
| Булгаков М.А.    | Роман      |
| Пастернак Б.Л.   | Поезія     |
| Єсенін С.А.      | Поезія     |
+------------------+------------+</pre>

    <h3>Завдання</h3>
    <p>
        Вивести інформацію про книги (назву книги, прізвище та ініціали автора, назву жанру, ціну та кількість
        примірників книги),
        написані в найпопулярніших жанрах, у відсортованому за алфавітом порядку за назвою книги.
        Найпопулярнішим вважати жанр, загальна кількість примірників книг якого на складі є максимальною.
    </p>

    <p><strong>Логічна схема бази даних:</strong></p>
    <div data-img-id="2.2.4.3"></div>


    <p class="gray-quote">
        Вивести інформацію про книги (назву книги, прізвище та ініціали автора, назву жанру, ціну та кількість
        примірників книги),
        написані в найпопулярніших жанрах, у відсортованому за алфавітом порядку за назвою книги.
        Найпопулярнішим вважати жанр, загальна кількість примірників книг якого на складі є максимальною.
    </p>

    <div id="toggle1" style="cursor: pointer;">
        <div><span class="arrow-text"><strong>Результат</strong></span></div>
    </div>
    <div id="hiddenText1" style="display:none;">
        <pre class="sqlResultTable">+-----------------------+------------------+------------+--------+--------+
| title                 | name_author      | name_genre | price  | amount |
+-----------------------+------------------+------------+--------+--------+
| Біла гвардія          | Булгаков М.А.    | Роман      | 540.50 | 5      |
| Брати Карамазови      | Достоєвський Ф.М.| Роман      | 799.01 | 3      |
| Гравець               | Достоєвський Ф.М.| Роман      | 480.50 | 10     |
| Ідіот                 | Достоєвський Ф.М.| Роман      | 460.00 | 10     |
| Лірика                | Пастернак Б.Л.   | Поезія     | 518.99 | 10     |
| Майстер і Маргарита   | Булгаков М.А.    | Роман      | 670.99 | 3      |
| Вірші та поеми        | Єсенін С.А.      | Поезія     | 650.00 | 15     |
| Чорна людина          | Єсенін С.А.      | Поезія     | 570.20 | 6      |
+-----------------------+------------------+------------+--------+--------+</pre>
    </div>

    <br>

    <div id="toggle2" style="cursor: pointer;">
        <div><span class="arrow-text"><strong>Структура та наповнення таблиць</strong></span></div>
    </div>
    <div id="hiddenText2" style="display:none;">
        <pre class="sqlResultTable">Таблиця genre:
+----------+-------------+
| genre_id | name_genre  |
+----------+-------------+
| 1        | Роман       |
| 2        | Поезія      |
| 3        | Пригоди     |
+----------+-------------+

Таблиця author:
+-----------+------------------+
| author_id | name_author      |
+-----------+------------------+
| 1         | Булгаков М.А.    |
| 2         | Достоєвський Ф.М.|
| 3         | Єсенін С.А.      |
| 4         | Пастернак Б.Л.   |
| 5         | Лермонтов М.Ю.   |
+-----------+------------------+

Таблиця book:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Майстер і Маргарита   | 1         | 1        | 670.99 | 3      |
| 2       | Біла гвардія          | 1         | 1        | 540.50 | 5      |
| 3       | Брати Карамазови      | 2         | 1        | 799.01 | 3      |
| 4       | Гравець               | 2         | 1        | 480.50 | 10     |
| 5       | Вірші та поеми        | 3         | 2        | 650.00 | 15     |
| 6       | Чорна людина          | 3         | 2        | 570.20 | 6      |
| 7       | Лірика                | 4         | 2        | 518.99 | 10     |
| 8       | Ідіот                 | 2         | 1        | 460.00 | 10     |
| 9       | Герой нашого часу     | 5         | 3        | 570.59 | 2      |
| 10      | Доктор Живаго         | 4         | 3        | 740.50 | 5      |
+---------+-----------------------+-----------+----------+--------+--------+</pre>
    </div>

</div>