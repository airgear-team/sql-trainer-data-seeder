<div class="container">
    <h2>Завдання</h2>

    <p>
        Порівняйте щомісячну виручку від продажу книг за поточний і попередній роки.
        Для цього виведіть рік, місяць, суму виручки у відсортованому спочатку за зростанням місяців, а потім за
        зростанням років вигляді.
        Назви стовпців: <strong>Рік</strong>, <strong>Місяць</strong>, <strong>Сума</strong>.
    </p>

    <h3>Фрагмент логічної схеми бази даних (у запиті НЕ ОБОВ'ЯЗКОВО використовувати всі таблиці):</h3>
    <div data-img-id="2.4.13.1"></div>

    <p>Інформація про продажі попереднього року зберігається в архівній таблиці <code>buy_archive</code>, яка
        створюється наприкінці року на основі інформації з таблиць бази даних і має таку структуру:</p>

    <table class="infoTable">
        <thead>
            <tr>
                <th>Назва стовпця</th>
                <th>Опис</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>buy_archive_id</td>
                <td>ключовий стовпець</td>
            </tr>
            <tr>
                <td>buy_id</td>
                <td>id замовлень, вибирається з таблиці buy</td>
            </tr>
            <tr>
                <td>client_id</td>
                <td>id клієнтів, вибирається з таблиці client</td>
            </tr>
            <tr>
                <td>book_id</td>
                <td>id книги, вибирається з таблиці book</td>
            </tr>
            <tr>
                <td>date_payment</td>
                <td>дата оплати замовлення (з buy_step для етапу «Оплата»)</td>
            </tr>
            <tr>
                <td>price</td>
                <td>ціна книги в цьому замовленні (з таблиці book)</td>
            </tr>
            <tr>
                <td>amount</td>
                <td>кількість куплених книг (з таблиці buy_book)</td>
            </tr>
        </tbody>
    </table>

    <p><strong>Важливо!</strong> Умовно вважаємо, що 2020 — поточний рік, а 2019 — попередній рік.</p>

    <h3>Оператор UNION</h3>

    <p>Оператор <code>UNION</code> використовується для об’єднання двох і більше SQL-запитів. Синтаксис:</p>

    <pre class="sqlCodeBlock">SELECT колонка_1, колонка_2, ...
FROM ...
UNION
SELECT колонка_1, колонка_2, ...
FROM ...
</pre>

    <p>Або:</p>

    <pre class="sqlCodeBlock">SELECT колонка_1, колонка_2, ...
FROM ...
UNION ALL
SELECT колонка_1, колонка_2, ...
FROM ...
</pre>

    <p>
        Важливо зазначити, що кожен із запитів <code>SELECT</code> повинен містити однакову кількість стовпців і сумісні
        типи повернених даних.
        Кожен запит може включати розділи <code>WHERE</code>, <code>GROUP BY</code> тощо.
    </p>

    <p>
        У результаті виконання цієї конструкції буде виведено таблицю, імена стовпців якої відповідають іменам стовпців
        з першого запиту.
        У таблиці результатів спочатку відображаються записи з першого запиту, а потім — з другого.
        Якщо використано ключове слово <code>ALL</code>, до результату включаються всі записи обох запитів,
        інакше — лише унікальні.
    </p>

    <h3>Приклад</h3>

    <p>
        Вивести всіх клієнтів, які робили замовлення або в цьому, або в попередньому році.
    </p>

    <p>
        На цьому прикладі розглянемо різницю між <code>UNION</code> та <code>UNION ALL</code>.
    </p>

    <p>
        З <code>UNION</code> клієнти будуть виведені без повторень:
    </p>

    <pre class="sqlCodeBlock">-- UNION (без повторень)
SELECT name_client
FROM buy_archive
INNER JOIN client USING(client_id)
UNION
SELECT name_client
FROM buy
INNER JOIN client USING(client_id)
</pre>

    <p class="skewed">Результат:</strong></p>

    <pre class="sqlCodeBlock">+-----------------+
| name_client     |
+-----------------+
| Баранов Павел   |
| Абрамова Катя   |
| Яковлева Галина |
| Семенонов Иван  |
+-----------------+
Affected rows: 4</pre>

    <p>
        З <code>UNION ALL</code> будуть виведені клієнти з повтореннями
        (для тих, хто замовляв книги в обох роках, а також кілька разів в одному році).
    </p>

    <pre class="sqlCodeBlock">SELECT name_client
FROM buy_archive
INNER JOIN client USING(client_id)
UNION ALL
SELECT name_client
FROM buy
INNER JOIN client USING(client_id)
</pre>

    <p class="skewed">Результат (з повторами):</p>


    <pre class="sqlCodeBlock">+-----------------+
| name_client     |
+-----------------+
| Баранов Павел   |
| Баранов Павел   |
| Абрамова Катя   |
| Абрамова Катя   |
| Абрамова Катя   |
| Яковлева Галина |
| Яковлева Галина |
| Баранов Павел   |
| Абрамова Катя   |
| Абрамова Катя   |
| Баранов Павел   |
| Баранов Павел   |
| Абрамова Катя   |
| Семенонов Иван  |
+-----------------+
Affected rows: 14</pre>


    <h3>Приклад</h3>

    <p>Вивести інформацію про оплачені замовлення за обидва роки, відсортовану за <code>client_id</code>:</p>

    <p class="skewed">Запит:</p>

    <pre class="sqlCodeBlock">SELECT buy_id, client_id, book_id, date_payment, amount, price
FROM buy_archive
UNION ALL
SELECT buy.buy_id, client_id, book_id, date_step_end, buy_book.amount, price
FROM book
INNER JOIN buy_book USING(book_id)
INNER JOIN buy USING(buy_id)
INNER JOIN buy_step USING(buy_id)
INNER JOIN step USING(step_id)
WHERE date_step_end IS NOT NULL AND name_step = "Оплата"
ORDER BY client_id
</pre>

    <p class="skewed">Результат:</p>

    <pre class="sqlCodeBlock">+--------+-----------+---------+--------------+--------+--------+
| buy_id | client_id | book_id | date_payment | amount | price  |
+--------+-----------+---------+--------------+--------+--------+
| 2      | 1         | 1       | 2019-02-21   | 2      | 670.60 |
| 2      | 1         | 3       | 2019-02-21   | 1      | 450.90 |
| 1      | 2         | 2       | 2019-02-10   | 2      | 520.30 |
| 1      | 2         | 4       | 2019-02-10   | 3      | 780.90 |
| 1      | 2         | 3       | 2019-02-10   | 1      | 450.90 |
| 3      | 4         | 4       | 2019-03-05   | 4      | 780.90 |
| 3      | 4         | 5       | 2019-03-05   | 2      | 480.90 |
| 4      | 1         | 6       | 2019-03-12   | 1      | 650.00 |
| 5      | 2         | 1       | 2019-03-18   | 2      | 670.60 |
| 5      | 2         | 4       | 2019-03-18   | 1      | 780.90 |
| 1      | 1         | 3       | 2020-02-20   | 1      | 460.00 |
| 1      | 1         | 7       | 2020-02-20   | 2      | 570.20 |
| 1      | 1         | 1       | 2020-02-20   | 1      | 670.99 |
| 2      | 3         | 8       | 2020-02-28   | 2      | 518.99 |
| 3      | 2         | 1       | 2020-03-05   | 1      | 670.99 |
| 3      | 2         | 2       | 2020-03-05   | 1      | 540.50 |
| 3      | 2         | 3       | 2020-03-05   | 2      | 460.00 |
+--------+-----------+---------+--------------+--------+--------+</pre>

    <p>
        У результат спочатку включені записи з архівної таблиці, а потім — інформація про оплачені замовлення поточного
        року.
        Щоб змінити порядок відображення записів в об’єднаному запиті, можна використати сортування по всіх об’єднаних
        записах.
        У цьому випадку ключові слова <code>ORDER BY</code> вказуються після останнього запиту:
    </p>

    <pre class="sqlCodeBlock">SELECT buy_id, client_id, book_id, date_payment, amount, price
FROM 
    buy_archive
UNION ALL
SELECT buy.buy_id, client_id, book_id, date_step_end, buy_book.amount, price
FROM 
    book 
    INNER JOIN buy_book USING(book_id)
    INNER JOIN buy USING(buy_id) 
    INNER JOIN buy_step USING(buy_id)
    INNER JOIN step USING(step_id)                  
WHERE  date_step_end IS NOT Null and name_step = "Оплата"
ORDER BY client_id</pre>

    <p class="skewed">Результат:</p>


    <pre class="sqlCodeBlock">+--------+-----------+---------+--------------+--------+--------+
| buy_id | client_id | book_id | date_payment | amount | price  |
+--------+-----------+---------+--------------+--------+--------+
| 2      | 1         | 3       | 2019-02-21   | 1      | 450.90 |
| 2      | 1         | 1       | 2019-02-21   | 2      | 670.60 |
| 1      | 1         | 3       | 2020-02-20   | 1      | 460.00 |
| 1      | 1         | 7       | 2020-02-20   | 2      | 570.20 |
| 4      | 1         | 6       | 2019-03-12   | 1      | 650.00 |
| 1      | 1         | 1       | 2020-02-20   | 1      | 670.99 |
| 3      | 2         | 1       | 2020-03-05   | 1      | 670.99 |
| 3      | 2         | 2       | 2020-03-05   | 1      | 540.50 |
| 3      | 2         | 3       | 2020-03-05   | 2      | 460.00 |
| 5      | 2         | 4       | 2019-03-18   | 1      | 780.90 |
| 5      | 2         | 1       | 2019-03-18   | 2      | 670.60 |
| 1      | 2         | 3       | 2019-02-10   | 1      | 450.90 |
| 1      | 2         | 4       | 2019-02-10   | 3      | 780.90 |
| 1      | 2         | 2       | 2019-02-10   | 2      | 520.30 |
| 2      | 3         | 8       | 2020-02-28   | 2      | 518.99 |
| 3      | 4         | 5       | 2019-03-05   | 2      | 480.90 |
| 3      | 4         | 4       | 2019-03-05   | 4      | 780.90 |
+--------+-----------+---------+--------------+--------+--------+</pre>


    <div id="toggle0" style="cursor: pointer;">
        <div><span class="arrow-text"><strong>Пов’язані кроки</strong></span></div>
    </div>
    <div id="hiddenText0" style="display:none;">
        <ul>
            <li>вибірка стовпців і їх перейменування;</li>
            <li>з’єднання таблиць;</li>
            <li>виділення номера місяця з дати;</li>
            <li>виділення частини дати;</li>
            <li>групові функції (кілька кроків);</li>
            <li>умова відбору (кілька кроків);</li>
            <li>порівняння з порожнім значенням;</li>
            <li>сортування.</li>
        </ul>
    </div>

    <p></p>

    <p><strong>Текст завдання</strong> (щоб не прокручувати сторінку):</p>
    <p class="gray-quote">
        Порівняти щомісячну виручку від продажу книг за поточний і попередній роки.
        Для цього вивести рік, місяць, суму виручки у відсортованому спочатку за зростанням місяців, потім за зростанням
        років вигляді.
        Назви стовпців: <strong>Рік</strong>, <strong>Місяць</strong>, <strong>Сума</strong>.
    </p>

    <div id="toggle2" style="cursor: pointer;">
        <div><span class="arrow-text"><strong>Пояснення</strong></span></div>
    </div>
    <div id="hiddenText2" style="display:none;">
        <p>
            Щомісячна виручка розраховується як сума добутків ціни книги на кількість, замовлену користувачем у цьому
            місяці.
            Ціна книги для поточного року зберігається в таблиці <code>book</code>, а для попереднього — у
            <code>buy_archive</code>.<br>
            Функція для виділення місяця розглядається в одному з попередніх кроків.
        </p>
    </div>

    <p></p>

    <div id="toggle3" style="cursor: pointer;">
        <div><span class="arrow-text"><strong>Результат</strong></span></div>
    </div>
    <div id="hiddenText3" style="display:none;">
        <pre class="sqlResultTable">+------+----------+---------+
| Рік  | Місяць   | Сума    |
+------+----------+---------+
| 2019 | February | 5626.30 |
| 2020 | February | 3309.37 |
| 2019 | March    | 6857.50 |
| 2020 | March    | 2131.49 |
+------+----------+---------+</pre>
    </div>

    <p></p>

    <div id="toggle4" style="cursor: pointer;">
        <div><span class="arrow-text"><strong>Наповнення таблиць</strong></span></div>
    </div>
    <div id="hiddenText4" style="display:none;">
        <div data-img-id="2.4.4.1"></div>
    </div>
</div>