<div class="container">

    <h2>Запити на оновлення, пов’язані таблиці</h2>

    <p>
        В запитах на оновлення можна використовувати пов’язані таблиці:
    </p>

    <pre class="sqlResultTable">UPDATE таблиця_1
     ... JOIN таблиця_2
     ON вираз
     ...
SET ...   
WHERE ...;
</pre>

    <p>
        При цьому виправляти дані можна у всіх використаних у запиті таблицях.
    </p>

    <h3>Приклад</h3>

    <p>
        Для книг, які вже є на складі (у таблиці <code>book</code>) за тією ж ціною, що й у поставці
        (<code>supply</code>),
        потрібно збільшити кількість на значення, вказане в поставці, а також обнулити кількість цих книг у поставці.
    </p>
    <p>
        Цей запит має відібрати рядки з таблиць <code>book</code> і <code>supply</code> такі, що в них збігаються і
        автор, і назва книги.
        Але в таблиці <code>supply</code> прізвище автора записане не числом (<em>id</em>), а текстом.
        Відповідно, щоб виконати порівняння за прізвищем автора, потрібно "підтягнути" таблицю <code>author</code>,
        яка пов’язана з <code>book</code> через стовпець <code>author_id</code>.
        У логічному виразі, який описує з’єднання таблиць, можна буде використовувати стовпці з таблиць
        <code>book</code>, <code>author</code> і <code>supply</code>.
    </p>
    <p>
        Якщо таблиці логічно пов’язані за двома або більше стовпцями (на схемі зв’язки позначені лініями),
        можливо через інші таблиці, то умова з’єднання включатиме зв’язки за потрібними стовпцями через логічний
        оператор <code>AND</code>.
        Наприклад, для наступних таблиць можна вказати логічний зв’язок за назвою книги і автором:
    </p>


    <div data-img-id="2.3.1.1"></div>


    <p>умову з'єднання можна записати у вигляді:</p>


    <pre class="sqlResultTable">book INNER JOIN author ON author.author_id = book.author_id
     INNER JOIN supply ON book.title = supply.title 
                          AND supply.author = author.name_author
</pre>

    <p class="skewed">Запит:</p>
    <pre class="sqlResultTable">UPDATE book 
     INNER JOIN author ON author.author_id = book.author_id
     INNER JOIN supply ON book.title = supply.title 
                         AND supply.author = author.name_author
SET book.amount = book.amount + supply.amount,
    supply.amount = 0   
WHERE book.price = supply.price;

SELECT * FROM book;
SELECT * FROM supply;
</pre>

    <p class="skewed">Результат:</p>
    <pre class="sqlResultTable">Affected rows: 4

+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+

Affected rows: 8

+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 0      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 0      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+
</pre>


    <p>
        Під задану умову підпадають дві книги — «Біла гвардія» Булгакова та «Чорна людина» Єсеніна.
        У таблиці <code>book</code> їх кількість була збільшена, а в таблиці <code>supply</code> — обнулена.
    </p>

    <h3>Завдання</h3>

    <p>
        Для книг, які вже є на складі (у таблиці <code>book</code>), але за іншою ціною, ніж у поставці
        (<code>supply</code>),
        необхідно в таблиці <code>book</code> збільшити кількість на значення, вказане в поставці, та перерахувати ціну.
        А в таблиці <code>supply</code> — обнулити кількість цих книг.
        Формула для перерахунку ціни:
    </p>

    <div data-img-id="2.3.1.2"></div>


    <p>
        де <code>p<sub>1</sub></code>, <code>p<sub>2</sub></code> — ціна книги у таблицях <code>book</code> та
        <code>supply</code> відповідно;<br>
        <code>k<sub>1</sub></code>, <code>k<sub>2</sub></code> — кількість книг у таблицях <code>book</code> та
        <code>supply</code> відповідно.
    </p>


    <div id="toggle0" style="cursor: pointer;">
        <div><span class="arrow-text"><strong>Пояснення</strong></span></div>
    </div>
    <div id="hiddenText0" style="display:none;">
        <p>
            Перераховуватися повинна ціна лише однієї книги Достоєвського «Ідіот».
            Для цієї ж книги збільшується кількість у таблиці <code>book</code> та обнуляється кількість у
            <code>supply</code>.
        </p>
    </div>

    <p></p>

    <div id="toggle1" style="cursor: pointer;">
        <div><span class="arrow-text"><strong>Результат</strong></span></div>
    </div>
    <div id="hiddenText1" style="display:none;">
        <pre class="sqlResultTable">Affected rows: 2

+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 437.11 | 13     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+

Affected rows: 6

+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 0      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+
</pre>
    </div>

    <p></p>

    <div id="toggle2" style="cursor: pointer;">
        <div><span class="arrow-text"><strong>Структура</strong></span></div>
    </div>
    <div id="hiddenText2" style="display:none;">
        <pre class="sqlResultTable">Таблиця book:
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+

Таблиця supply:
+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+

Таблиця author:                          Таблиця genre:
+-----------+------------------+         +----------+-------------+
| author_id | name_author      |         | genre_id | name_genre  |
+-----------+------------------+         +----------+-------------+
| 1         | Булгаков М.А.    |         | 1        | Роман       |
| 2         | Достоевський Ф.М.|         | 2        | Поезія      |
| 3         | Єсенін С.А.      |         | 3        | Пригоди     |
| 4         | Пастернак Б.Л.   |         +----------+-------------+
| 5         | Лермонтов М.Ю.   |
+-----------+------------------+
</pre>
    </div>
</div>